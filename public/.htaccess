# Activation du module de réécriture d'URL
RewriteEngine On

# Définition du répertoire de base (commenté pour être compatible avec Hostinger)
# RewriteBase /portfolio/
RewriteBase /

# Redirection de www vers non-www
RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
RewriteRule ^(.*)$ http://%1/$1 [R=301,L]

# Redirection de HTTP vers HTTPS (pour la production)
# Commenté temporairement pour faciliter les tests
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Protection des fichiers sensibles
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

# Protection du fichier .env
<Files .env>
    Order allow,deny
    Deny from all
</Files>

# Protection des fichiers de configuration avec des exceptions pour les fichiers publics
<FilesMatch "^(composer\.json|composer\.lock|package\.json|package-lock\.json|README\.md|\.(env|sql|json|lock|gitignore|htaccess))$">
    # Exception pour les fichiers de test et publics
    <Files "hostinger_test.php">
        Order allow,deny
        Allow from all
    </Files>
    
    Order allow,deny
    Deny from all
</FilesMatch>

# Bloquer l'accès au dossier backend
<IfModule mod_rewrite.c>
    RewriteRule ^backend(/.*)?$ - [F,L]
</IfModule>

# Redirection de toutes les requêtes vers index.php, sauf pour les fichiers et dossiers existants
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^ index.php [L]

# Compression GZIP
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/x-javascript application/json
</IfModule>

# Cache des fichiers statiques
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    ExpiresByType application/json "access plus 0 seconds"
</IfModule>

# En-têtes de sécurité
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    Header set X-XSS-Protection "1; mode=block"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    Header set Strict-Transport-Security "max-age=31536000; includeSubDomains" env=HTTPS
    
    # En-têtes CORS (à personnaliser selon vos besoins)
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header set Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization"
</IfModule>

# Protection contre les injections de fichiers
<IfModule mod_rewrite.c>
    RewriteCond %{REQUEST_METHOD} GET
    RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=http:// [OR]
    RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=https:// [OR]
    RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=ftp://
    RewriteRule .* - [F]
</IfModule>

# Désactivation de l'affichage du contenu des répertoires
Options -Indexes

# Définition du type MIME par défaut
DefaultType application/x-httpd-php

# Définition du jeu de caractères par défaut
AddDefaultCharset UTF-8

# Définition de la page d'erreur 404
ErrorDocument 404 /404

# Définition de la page d'erreur 500
ErrorDocument 500 /500

# Redirection vers le dossier public
RewriteCond %{REQUEST_URI} !^/public/
RewriteRule ^(.*)$ /public/$1 [L] 